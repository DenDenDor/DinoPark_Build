<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>DinoPark</title>
  <style>
    body { margin: 0; overflow: hidden; touch-action: none; }
    #unity-canvas { 
      position: fixed; 
      width: 100%; 
      height: 100%; 
      background: #1F1F20;
    }
    #progress-bar {
      position: absolute; 
      left: 0%; 
      right: 100%; 
      top: 49%; 
      bottom: 49%; 
      background-color: white;
      transition: right 0.1s;
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <canvas id="unity-canvas"></canvas>
  <div id="progress-bar"></div>
  
  <script src="Build/brotli-check.js"></script>
  <script src="Build/43e87b82af8b41e9b8f21b9c6a1fe983.loader.js"></script>
  
  <script>
    // Telegram WebApp Integration
    function GetTelegramAuth() {
      try {
        if (window.Telegram && window.Telegram.WebApp) {
          const initData = Telegram.WebApp.initDataUnsafe;
          const user = initData.user || {};
          
          const authData = {
            id: user.id || '',
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            username: user.username || '',
            language_code: user.language_code || 'en',
            allows_write_to_pm: user.allows_write_to_pm || false,
            photo_url: user.photo_url || '',
            auth_date: initData.auth_date || '',
            hash: initData.hash || '',
            query_id: initData.query_id || ''
          };
          
          return JSON.stringify(authData);
        }
        return JSON.stringify({ error: "Not in Telegram" });
      } catch (e) {
        console.error("Telegram auth error:", e);
        return JSON.stringify({ error: e.message });
      }
    }

    // Expose to Unity
    mergeInto(LibraryManager.library, {
      GetTelegramAuth: function() {
        const json = GetTelegramAuth();
        const buffer = _malloc(json.length + 1);
        stringToUTF8(json, buffer, buffer.length);
        return buffer;
      },
      _free: function(ptr) { 
        _free(ptr); 
      }
    });

    // Unity Initialization
    const settings = {
      dataUrl: "Build/a453f5a1e2561d2ebc464dd1cc4e6df8.data",
      frameworkUrl: "Build/312b52aa20db2eccba41bb74bf8dbae5.framework.js",
      codeUrl: "Build/07919eac42ecc5c6e33eaa5ac56bd16d.wasm",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "DinoPark",
      productVersion: "0.0.76",
      matchWebGLToCanvasSize: true,
    };

    const progressBar = document.querySelector("#progress-bar");

    // Initialize Telegram WebApp if available
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.expand();
      Telegram.WebApp.enableClosingConfirmation();
      Telegram.WebApp.BackButton.show();
      
      Telegram.WebApp.BackButton.onClick(function() {
        // Handle back button if needed
      });
    }

    // Start Unity after short delay
    setTimeout(() => {
      createUnityInstance(document.querySelector("#unity-canvas"), settings, (progress) => {
        progressBar.style.right = 100 * (1 - progress) + "%";
      }).then((unityInstance) => {
        progressBar.style.display = "none";
        
        // Optional: Send Telegram data to Unity after initialization
        if (window.Telegram && Telegram.WebApp) {
          const authData = GetTelegramAuth();
          unityInstance.SendMessage('TelegramManager', 'OnTelegramAuth', authData);
        }
      }).catch((message) => {
        alert("Initialization failed: " + message);
      });
    }, 500);
  </script>
</body>
</html>
